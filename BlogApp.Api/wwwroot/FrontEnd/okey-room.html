<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend/okey Otaqları</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .user-details h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .balance {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #f59e0b;
            font-weight: bold;
            font-size: 16px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        /* Rooms Grid */
        .rooms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

            .rooms-header h2 {
                color: white;
                font-size: 28px;
            }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .room-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
            cursor: pointer;
        }

            .room-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .room-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .room-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-waiting {
            background: #fef3c7;
            color: #92400e;
        }

        .status-playing {
            background: #fee2e2;
            color: #991b1b;
        }

        .room-info {
            margin-top: 15px;
        }

        .room-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #666;
        }

            .room-info-item strong {
                color: #333;
            }

        .room-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

            .modal-header h3 {
                font-size: 24px;
                color: #333;
            }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #333;
                font-weight: 600;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 16px;
                transition: border 0.3s;
            }

                .form-group input:focus,
                .form-group select:focus {
                    outline: none;
                    border-color: #667eea;
                }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: none;
            min-width: 300px;
        }

            .notification.show {
                display: block;
                animation: slideIn 0.3s;
            }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }

        /* Room View */
        .room-view {
            display: none;
        }

            .room-view.active {
                display: block;
            }

        .room-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .room-title {
            text-align: center;
            font-size: 28px;
            color: #333;
            margin-bottom: 30px;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-slot {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border: 3px dashed #cbd5e1;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

            .player-slot.filled {
                background: linear-gradient(135deg, #667eea, #764ba2);
                border: 3px solid #5a67d8;
            }

                .player-slot.filled .player-name {
                    color: white;
                    font-size: 20px;
                    font-weight: bold;
                }

            .player-slot.empty {
                color: #9ca3af;
                font-size: 16px;
            }

        .room-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .game-status {
            text-align: center;
            padding: 20px;
            background: #fef3c7;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #92400e;
            font-weight: 600;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Notification -->
        <div id="notification" class="notification">
            <div id="notificationMessage"></div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <h3 id="userName">Gözləyir...</h3>
                    <div class="balance">
                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                        </svg>
                        <span id="userBalance">0</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="showCreateRoomModal()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Otaq Yarat
            </button>
        </div>

        <!-- Lobby View -->
        <div id="lobbyView">
            <div class="rooms-header">
                <h2>🎮 Aktiv Otaqlar</h2>
                <button class="btn btn-primary" onclick="refreshRooms()">
                    <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    Yenilə
                </button>
            </div>
            <div id="roomsGrid" class="rooms-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Otaqlar yüklənir...</p>
                </div>
            </div>
        </div>

        <!-- Room View -->
        <div id="roomView" class="room-view">
            <div class="room-container">
                <h2 class="room-title" id="currentRoomName">Otaq</h2>

                <div class="game-status" id="gameStatus">
                    Oyunçular gözlənilir... (4 oyunçu lazımdır)
                </div>

                <div class="players-grid" id="playersGrid">
                    <div class="player-slot empty">
                        <svg style="width: 48px; height: 48px;" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6z" />
                        </svg>
                        <p>Oyunçu gözlənilir</p>
                    </div>
                    <div class="player-slot empty">
                        <svg style="width: 48px; height: 48px;" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6z" />
                        </svg>
                        <p>Oyunçu gözlənilir</p>
                    </div>
                    <div class="player-slot empty">
                        <svg style="width: 48px; height: 48px;" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6z" />
                        </svg>
                        <p>Oyunçu gözlənilir</p>
                    </div>
                    <div class="player-slot empty">
                        <svg style="width: 48px; height: 48px;" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6z" />
                        </svg>
                        <p>Oyunçu gözlənilir</p>
                    </div>
                </div>

                <div class="room-actions">
                    <button class="btn btn-danger" onclick="leaveRoom()">
                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                        </svg>
                        Otaqdan Çıx
                    </button>
                </div>
            </div>
        </div>

        <!-- Create Room Modal -->
        <div id="createRoomModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Yeni Otaq Yarat</h3>
                    <button class="close-btn" onclick="closeCreateRoomModal()">&times;</button>
                </div>
                <form onsubmit="createRoom(event)">
                    <div class="form-group">
                        <label>Otaq Adı</label>
                        <input type="text" id="roomNameInput" placeholder="Məs: VIP Otaq" required>
                    </div>
                    <div class="form-group">
                        <label>Giriş Haqqı</label>
                        <select id="entryFeeInput">
                            <option value="20">20 Coin</option>
                            <option value="50" selected>50 Coin</option>
                            <option value="100">100 Coin</option>
                            <option value="200">200 Coin</option>
                            <option value="500">500 Coin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Otaq Yarat</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentRoomId = null;

        // SignalR Connection
        async function initSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/okeyhub")
                .withAutomaticReconnect()
                .build();

            // Events
            connection.on("UserData", (data) => {
                document.getElementById('userName').textContent = data.fullName;
                document.getElementById('userBalance').textContent = data.balance;
                document.getElementById('userAvatar').textContent = data.fullName.charAt(0).toUpperCase();
            });

            connection.on("OkeyRoomCreated", (room) => {
                showNotification('Otaq yaradıldı!', 'success');
                refreshRooms();
            });

            connection.on("RoomDeleted", (roomId) => {
                refreshRooms();
            });

            connection.on("JoinedRoom", (data) => {
                currentRoomId = data.roomId;
                document.getElementById('userBalance').textContent = data.balance;
                document.getElementById('currentRoomName').textContent = data.roomName;
                showRoomView();
                showNotification('Otağa qoşuldunuz!', 'success');
            });

            connection.on("JoinError", (message) => {
                showNotification(message, 'error');
            });

            connection.on("PlayerJoined", (playerName) => {
                showNotification(`${playerName} otağa qoşuldu`, 'info');
            });

            connection.on("PlayerLeft", (playerName) => {
                showNotification(`${playerName} otaqdan çıxdı`, 'info');
            });

            connection.on("PlayersList", (players) => {
                updatePlayersGrid(players);
            });

            connection.on("GameStarted", (data) => {
                showNotification(data.message, 'success');
                // Oyun başladı - Frontend/okey.html-ə yönləndir
                setTimeout(() => {
                    window.location.href = '/Frontend/okey.html';
                }, 2000);
            });

            connection.on("LeftRoom", () => {
                currentRoomId = null;
                showLobbyView();
                refreshRooms();
            });

            connection.on("GameCancelled", (data) => {
                showNotification(data.message, 'error');
                if (data.refund) {
                    setTimeout(() => refreshUserData(), 1000);
                }
            });

            try {
                await connection.start();
                console.log("✅ SignalR connected");
                await refreshRooms();
            } catch (err) {
                console.error("❌ SignalR connection error:", err);
                showNotification('Bağlantı xətası! Yenidən cəhd edin.', 'error');
            }
        }

        // Rooms
        async function refreshRooms() {
            try {
                const rooms = await connection.invoke("GetRoomList");
                displayRooms(rooms);
            } catch (err) {
                console.error("❌ GetRoomList error:", err);
            }
        }

        function displayRooms(rooms) {
            const grid = document.getElementById('roomsGrid');

            if (rooms.length === 0) {
                grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">
                            <svg style="width: 64px; height: 64px; margin: 0 auto 20px;" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <h3>Aktiv otaq yoxdur</h3>
                            <p style="margin-top: 10px;">İlk otağı siz yaradın!</p>
                        </div>
                    `;
                return;
            }

            grid.innerHTML = rooms.map(room => `
                    <div class="room-card" onclick="joinRoom('${room.roomId}')">
                        <div class="room-header">
                            <div class="room-name">${room.roomName}</div>
                            <div class="room-status ${room.isGameStarted ? 'status-playing' : 'status-waiting'}">
                                ${room.isGameStarted ? '🎮 Oyunda' : '⏳ Gözləyir'}
                            </div>
                        </div>
                        <div class="room-info">
                            <div class="room-info-item">
                                <span>Yaradıcı:</span>
                                <strong>${room.creatorName}</strong>
                            </div>
                            <div class="room-info-item">
                                <span>Oyunçular:</span>
                                <strong>${room.playerCount} / 4</strong>
                            </div>
                            <div class="room-info-item">
                                <span>Giriş haqqı:</span>
                                <strong style="color: #f59e0b;">${room.entryFee} Coin</strong>
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        async function joinRoom(roomId) {
            try {
                await connection.invoke("JoinRoom", roomId);
            } catch (err) {
                console.error("❌ JoinRoom error:", err);
                showNotification('Otağa qoşula bilmədi', 'error');
            }
        }

        async function leaveRoom() {
            if (!currentRoomId) return;

            try {
                await connection.invoke("LeaveRoom");
            } catch (err) {
                console.error("❌ LeaveRoom error:", err);
            }
        }

        // Create Room
        function showCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('active');
        }

        function closeCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('active');
        }

        async function createRoom(e) {
            e.preventDefault();

            const roomName = document.getElementById('roomNameInput').value;
            const entryFee = parseFloat(document.getElementById('entryFeeInput').value);

            try {
                const result = await connection.invoke("CreateRoom", roomName, entryFee);

                if (result.success) {
                    closeCreateRoomModal();
                    document.getElementById('roomNameInput').value = '';

                    // Otağa avtomatik qoşul
                    setTimeout(() => joinRoom(result.roomId), 500);
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (err) {
                console.error("❌ CreateRoom error:", err);
                showNotification('Otaq yaratmaq alınmadı', 'error');
            }
        }

        // Players Grid
        function updatePlayersGrid(players) {
            const grid = document.getElementById('playersGrid');
            const slots = grid.querySelectorAll('.player-slot');

            // Status güncəllə
            const status = document.getElementById('gameStatus');
            if (players.length === 4) {
                status.textContent = '✅ Oyun başlayır...';
                status.style.background = '#d1fae5';
                status.style.color = '#065f46';
            } else {
                status.textContent = `Oyunçular gözlənilir... (${players.length}/4)`;
                status.style.background = '#fef3c7';
                status.style.color = '#92400e';
            }

            // Oyunçuları göstər
            for (let i = 0; i < 4; i++) {
                if (players[i]) {
                    slots[i].className = 'player-slot filled';
                    slots[i].innerHTML = `
                            <div style="font-size: 32px; margin-bottom: 10px;">
                                ${players[i].isCurrentTurn ? '👑' : '👤'}
                            </div>
                            <div class="player-name">${players[i].name}</div>
                            <div style="color: rgba(255,255,255,0.8); margin-top: 5px;">
                                ${players[i].tileCount > 0 ? `${players[i].tileCount} daş` : 'Hazır'}
                            </div>
                        `;
                } else {
                    slots[i].className = 'player-slot empty';
                    slots[i].innerHTML = `
                            <svg style="width: 48px; height: 48px;" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6z"/>
                            </svg>
                            <p>Oyunçu gözlənilir</p>
                        `;
                }
            }
        }

        // Views
        function showLobbyView() {
            document.getElementById('lobbyView').style.display = 'block';
            document.getElementById('roomView').classList.remove('active');
        }

        function showRoomView() {
            document.getElementById('lobbyView').style.display = 'none';
            document.getElementById('roomView').classList.add('active');
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');

            notification.className = `notification ${type} show`;
            messageEl.textContent = message;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('createRoomModal');
            if (event.target === modal) {
                closeCreateRoomModal();
            }
        }

        // Initialize on load
        window.onload = function () {
            initSignalR();
        };
    </script>
</body>
</html>